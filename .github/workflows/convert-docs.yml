name: Convert Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'components/**/Eco.Core1_EN.fodt'  # for tests purpose one file only
  workflow_dispatch:  # Allow manual triggering

jobs:
  convert-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # For source repo
      id-token: write  # For GitHub App token

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Needed for git diff

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache APT packages
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-apt-${{ hashFiles('**/convert-docs.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Cache Python packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/convert-docs.yml') }}
        restore-keys: |
          ${{ runner.os }}-pip-



    - name: Install LibreOffice and extension
      id: install-libreoffice
      run: |
        echo "=== LIBREOFFICE INSTALLATION START ==="
        echo "ğŸ“¦ Updating package lists..."
        if sudo apt-get update; then
          echo "âœ… Package lists updated successfully"
        else
          echo "âŒ Failed to update package lists"
          exit 1
        fi
        
        echo "ğŸ“¦ Installing LibreOffice..."
        if sudo apt-get install libreoffice -y; then
          echo "âœ… LibreOffice installed successfully"
        else
          echo "âŒ Failed to install LibreOffice"
          exit 1
        fi
        
        echo "ğŸ Installing Python dependencies..."
        if pip install frontmatter; then
          echo "âœ… Python frontmatter package installed"
        else
          echo "âŒ Failed to install frontmatter package"
          exit 1
        fi
        
        # Install the DocExport extension using unopkg for current user
        echo "ğŸ”§ Installing DocExport extension..."
        if [ -f ".github/workflows/DocExport.oxt" ]; then
          echo "âœ… DocExport.oxt file found"
          echo "ğŸ“Š Extension file size: $(stat -c%s .github/workflows/DocExport.oxt) bytes"
          
          if unopkg add .github/workflows/DocExport.oxt; then
            echo "âœ… Extension installation completed successfully"
            echo "ğŸ” Listing installed extensions:"
            unopkg list --user 2>/dev/null || echo "Cannot list extensions"
          else
            echo "âŒ Extension installation failed"
            echo "ğŸ” Checking unopkg availability:"
            which unopkg || echo "unopkg not found in PATH"
            exit 1
          fi
        else
          echo "âŒ ERROR: DocExport.oxt not found!"
          echo "ğŸ” Contents of .github/workflows directory:"
          ls -la .github/workflows/ || echo "Directory not accessible"
          exit 1
        fi
        
        # Verify LibreOffice is working
        echo "ğŸ” Verifying LibreOffice installation..."
        if soffice --version; then
          echo "âœ… LibreOffice verification successful"
        else
          echo "âŒ LibreOffice verification failed"
          exit 1
        fi
        echo "=== LIBREOFFICE INSTALLATION COMPLETE ==="

    - name: Debug Git State
      id: debug-git
      run: |
        echo "=== GIT STATE DEBUG ==="
        echo "Current commit (HEAD): $(git rev-parse HEAD)"
        echo "Previous commit (HEAD~1): $(git rev-parse HEAD~1 2>/dev/null || echo 'N/A - single commit')"
        echo "Fetch depth used: 2"
        echo "Git log (last 3 commits):"
        git log --oneline -3 || echo "Less than 3 commits available"
        echo "Files in components directory:"
        find components -name "*.fodt" -type f | head -10 || echo "No .fodt files found"
        echo "=== END GIT STATE DEBUG ==="

    - name: Find changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          components/**/*.fodt

    - name: Process Change Detection Results
      run: |
        echo "=== CHANGE DETECTION RESULTS ==="
        echo "Any files changed: ${{ steps.changed-files.outputs.any_changed }}"
        echo "Files added: ${{ steps.changed-files.outputs.added_files }}"
        echo "Files modified: ${{ steps.changed-files.outputs.modified_files }}"
        echo "Files deleted: ${{ steps.changed-files.outputs.deleted_files }}"
        echo "All changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
        
        if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
          file_count=$(echo '${{ steps.changed-files.outputs.all_changed_files }}' | wc -w)
          echo "âœ… CHANGES DETECTED: $file_count file(s) to process"
          
          # Check for deleted files
          deleted_files="${{ steps.changed-files.outputs.deleted_files }}"
          if [ -n "$deleted_files" ]; then
            echo "âš ï¸  DELETED FILES DETECTED: $deleted_files"
            echo "Note: Deleted files cannot be converted but may need cleanup in target repo"
          fi
          
          echo "Files to convert:"
          processable_files=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "  - $file"
            if [ -f "$file" ]; then
              file_size=$(stat -c%s "$file" 2>/dev/null || echo '0')
              echo "    âœ… File exists and is readable"
              echo "    ğŸ“Š File size: $file_size bytes"
              
              if [ "$file_size" -eq 0 ]; then
                echo "    âš ï¸  WARNING: File is empty (0 bytes)"
              elif [ "$file_size" -lt 100 ]; then
                echo "    âš ï¸  WARNING: File is very small ($file_size bytes) - may be incomplete"
              fi
              processable_files=$((processable_files + 1))
            else
              echo "    âŒ WARNING: File not found or not readable (likely deleted)"
            fi
          done
          
          echo "ğŸ“Š Summary: $processable_files processable files out of $file_count total changes"
        else
          echo "â„¹ï¸  NO CHANGES DETECTED"
          echo "Reason: No .fodt files in components/** have been modified since the last commit"
          echo "This is normal behavior - the workflow will skip conversion steps"
          
          # Additional debugging for no-changes scenario
          echo "ğŸ” Additional debugging information:"
          echo "  - Current workflow path filter: components/**/*.fodt"
          echo "  - Actual path filter used: ${{ steps.changed-files.outputs.files }}"
          echo "  - Comparison: HEAD vs HEAD~1"
          echo "  - Repository has $(git rev-list --count HEAD) total commits"
        fi
        echo "=== END CHANGE DETECTION RESULTS ==="

    - name: No Changes Detected
      if: steps.changed-files.outputs.any_changed != 'true'
      run: |
        echo "=== NO CONVERSION NEEDED ==="
        echo "â„¹ï¸  WORKFLOW RESULT: No changes detected"
        echo ""
        echo "This means:"
        echo "  â€¢ No .fodt files in components/** have been modified since the last commit"
        echo "  â€¢ The workflow is working correctly by skipping unnecessary conversions"
        echo "  â€¢ No files will be converted or pushed to the target repository"
        echo ""
        echo "If you expected changes to be detected:"
        echo "  1. Verify your .fodt files are in the components/ directory"
        echo "  2. Check that files were actually modified in the last commit"
        echo "  3. Ensure the workflow path filter matches your file locations"
        echo ""
        echo "Current workflow path filter: components/**/*.fodt"
        echo "=== WORKFLOW COMPLETE (NO ACTION REQUIRED) ==="

    - name: Convert to Markdown
      id: convert
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== CONVERSION START ==="
        file_count=$(echo '${{ steps.changed-files.outputs.all_changed_files }}' | wc -w)
        echo "ğŸ”„ Starting conversion of $file_count file(s)"
        echo "Files to convert: ${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Export GitHub environment variables for the script
        echo "GITHUB_SERVER_URL=${{ github.server_url }}" >> $GITHUB_ENV
        echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
        echo "GITHUB_SHA=${{ github.sha }}" >> $GITHUB_ENV
        
        # Create converted_docs directory and list contents before conversion
        mkdir -p converted_docs
        echo "Contents before conversion:"
        ls -la converted_docs/ || echo "Directory is empty"
        
        # Call the new extension-based conversion script with changed files as arguments
        echo "ğŸš€ Executing conversion script..."
        if bash .github/workflows/convert_docs_extension.sh ${{ steps.changed-files.outputs.all_changed_files }}; then
          echo "âœ… Conversion script completed successfully"
        else
          echo "âŒ Conversion script failed with exit code $?"
          echo "ğŸ” Checking for partial results..."
          ls -la converted_docs/ 2>/dev/null || echo "No converted_docs directory found"
          exit 1
        fi
        
    - name: Verify Conversion Results
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "=== CONVERSION VERIFICATION ==="
        
        if [ -d "converted_docs" ]; then
          echo "ğŸ“ Converted docs directory contents:"
          ls -la converted_docs/
          
          md_count=$(find converted_docs -name "*.md" | wc -l)
          echo "ğŸ“„ Total .md files created: $md_count"
          
          if [ $md_count -gt 0 ]; then
            echo "âœ… Conversion successful - found $md_count markdown file(s)"
            echo "ğŸ“‹ Generated files:"
            find converted_docs -name "*.md" -exec basename {} \; | sort
            
            echo "ğŸ“Š File sizes:"
            find converted_docs -name "*.md" -exec ls -lh {} \; | awk '{print "  " $9 ": " $5}'
          else
            echo "âš ï¸  WARNING: No markdown files were created"
            echo "ğŸ” Checking for other file types:"
            find converted_docs -type f | head -10
          fi
        else
          echo "âŒ ERROR: converted_docs directory not found"
          echo "ğŸ” Current directory contents:"
          ls -la
          exit 1
        fi
        echo "=== END CONVERSION VERIFICATION ==="

    - name: Clone, copy files, and push to docs repo
      id: deploy
      if: steps.changed-files.outputs.any_changed == 'true'
      env:
        TARGET_REPO_SSH_KEY: ${{ secrets.VITEPRESS_DEPLOY_TOKEN }}
      shell: bash
      run: |
        set -euo pipefail
        echo "=== DEPLOYMENT TO TARGET REPOSITORY START ==="
        echo "ğŸ¯ Target repository: peerf-eco/docs-vitepress"
        echo "ğŸ“‚ Source directory: converted_docs/"
        echo "ğŸ“‚ Target directory: docs/components/"
        
        # Setup SSH
        echo "ğŸ” Setting up SSH authentication..."
        if mkdir -p ~/.ssh; then
          echo "âœ… SSH directory created"
        else
          echo "âŒ Failed to create SSH directory"
          exit 1
        fi
        
        echo "ğŸ”‘ Adding GitHub to known hosts..."
        if ssh-keyscan -t ed25519,rsa github.com >> ~/.ssh/known_hosts; then
          echo "âœ… GitHub added to known hosts"
        else
          echo "âŒ Failed to add GitHub to known hosts"
          exit 1
        fi
        
        echo "ğŸ”‘ Starting SSH agent..."
        if eval "$(ssh-agent -s)"; then
          echo "âœ… SSH agent started"
        else
          echo "âŒ Failed to start SSH agent"
          exit 1
        fi
        
        echo "ğŸ”‘ Adding SSH key..."
        if ssh-add - <<< "$TARGET_REPO_SSH_KEY"; then
          echo "âœ… SSH key added successfully"
        else
          echo "âŒ Failed to add SSH key"
          echo "ğŸ” SSH key length: ${#TARGET_REPO_SSH_KEY} characters"
          exit 1
        fi
        
        # Clone and copy files
        echo "ğŸ’¾ Cloning target repository..."
        if git clone git@github.com:peerf-eco/docs-vitepress.git docs-vitepress; then
          echo "âœ… Repository cloned successfully"
          echo "ğŸ“ Cloned repository contents:"
          ls -la docs-vitepress/ | head -10
        else
          echo "âŒ Failed to clone repository"
          echo "ğŸ” Testing SSH connection to GitHub:"
          ssh -T git@github.com || echo "SSH connection test failed"
          exit 1
        fi
        
        # Verify source directory exists
        if [ ! -d "converted_docs" ]; then
          echo "âŒ ERROR: converted_docs directory not found"
          exit 1
        fi
        
        echo "ğŸ“‹ Files available for deployment:"
        ls -la converted_docs/
        
        targetDir="docs-vitepress/docs/components"
        mkdir -p "$targetDir"
        echo "ğŸ“ Created target directory: $targetDir"
        
        filesCopied=0
        filesSkipped=0
        echo "ğŸ”„ Starting file copy process..."
        
        while IFS= read -r file; do
          src="converted_docs/${file}"
          if [ -f "$src" ]; then
            if cp "$src" "$targetDir/"; then
              echo "  âœ… Copied: ${file} ($(stat -c%s "$src" 2>/dev/null || echo '?') bytes)"
              filesCopied=$((filesCopied+1))
            else
              echo "  âŒ Failed to copy: ${file}"
              filesSkipped=$((filesSkipped+1))
            fi
          else
            echo "  âš ï¸  Skipped (not a file): ${file}"
            filesSkipped=$((filesSkipped+1))
          fi
        done < <(ls converted_docs 2>/dev/null || echo "")
        
        echo "ğŸ“Š Copy summary: $filesCopied files copied, $filesSkipped files skipped"
        
        if [ $filesCopied -eq 0 ]; then
          echo "âš ï¸  WARNING: No files were copied to target repository"
        fi
        
        # Push changes
        pushd docs-vitepress >/dev/null
        git config user.name "Docs CI Bot"
        git config user.email "docs-bot@ecoos.dev"
        git add docs/components/
        # Check for changes and commit
        echo "ğŸ” Checking for changes in target repository..."
        git status --porcelain docs/components/
        
        if ! git diff --staged --quiet; then
          sha="${GITHUB_SHA:-unknown-sha}"
          echo "âœ… Changes detected, committing and pushing..."
          echo "ğŸ“ Commit message: Auto-update docs from ${sha}"
          git commit -m "Auto-update docs from ${sha}"
          
          if git push origin HEAD:main; then
            echo "ğŸš€ Successfully pushed to docs-vitepress repository"
          else
            echo "âŒ Failed to push to target repository"
            exit 1
          fi
        else
          echo "â„¹ï¸  No changes to commit - files may already be up to date"
        fi
        popd >/dev/null
        echo "=== DEPLOYMENT COMPLETE ==="
  
    - name: Generate and update components manifest
      id: manifest
      if: steps.changed-files.outputs.any_changed == 'true'
      env:
        TARGET_REPO_SSH_KEY: ${{ secrets.VITEPRESS_DEPLOY_TOKEN }}
      shell: bash
      run: |
        set -eo pipefail
        echo "=== MANIFEST GENERATION START ==="
        echo "ğŸ“„ Generating components manifest for updated documentation"
        
        pushd docs-vitepress >/dev/null
        
        # Check if package.json exists and is valid
        if [ ! -f "package.json" ]; then
          echo "âš ï¸  No package.json found in target repository, skipping manifest generation"
          echo "This is normal if the target repository doesn't use npm-based manifest generation"
          popd >/dev/null
          exit 0
        fi
        echo "âœ… Found package.json in target repository"
        
        # Validate JSON syntax
        if ! python3 -m json.tool package.json >/dev/null 2>&1; then
          echo "âŒ Invalid package.json syntax, skipping manifest generation"
          echo "ğŸ” First few lines of package.json:"
          head -5 package.json || echo "Cannot read package.json"
          popd >/dev/null
          exit 0
        fi
        echo "âœ… package.json syntax is valid"
        
        # Check if the required script exists
        if ! grep -q '"docs:generate-components"' package.json; then
          echo "âš ï¸  docs:generate-components script not found in package.json"
          echo "Available scripts:"
          grep -A 10 '"scripts"' package.json | head -15 || echo "No scripts section found"
          echo "Skipping manifest generation"
          popd >/dev/null
          exit 0
        fi
        echo "âœ… Found docs:generate-components script"
        
        echo "ğŸ“¦ Installing dependencies..."
        if npm ci 2>/dev/null; then
          echo "âœ… Dependencies installed successfully using npm ci"
        elif npm install 2>/dev/null; then
          echo "âœ… Dependencies installed successfully using npm install"
        else
          echo "âŒ Failed to install dependencies"
          echo "ğŸ” npm version: $(npm --version 2>/dev/null || echo 'not available')"
          echo "ğŸ” node version: $(node --version 2>/dev/null || echo 'not available')"
          echo "Skipping manifest generation"
          popd >/dev/null
          exit 0
        fi
        
        echo "ğŸ”„ Generating components manifest..."
        if npm run docs:generate-components; then
          echo "âœ… Manifest generation completed successfully"
        else
          echo "âŒ Failed to generate manifest"
          echo "ğŸ” Checking for existing manifest file:"
          ls -la .vitepress/components.json 2>/dev/null || echo "No existing manifest found"
          echo "Continuing without manifest update"
          popd >/dev/null
          exit 0
        fi
        
        # Setup SSH and push if manifest was generated
        if [ -f ".vitepress/components.json" ]; then
          echo "âœ… Manifest file generated: .vitepress/components.json"
          echo "ğŸ“Š Manifest file size: $(stat -c%s .vitepress/components.json 2>/dev/null || echo 'unknown') bytes"
          
          mkdir -p ~/.ssh
          ssh-keyscan -t ed25519,rsa github.com >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          ssh-add - <<< "$TARGET_REPO_SSH_KEY"
          
          git add .vitepress/components.json
          if ! git diff --staged --quiet; then
            echo "ğŸ“ Committing manifest changes..."
            git config user.name "Docs CI Bot"
            git config user.email "docs-bot@ecoos.dev"
            git commit -m "Auto-update components manifest from ${GITHUB_SHA:-unknown-sha}"
            
            if git push origin HEAD:main; then
              echo "ğŸš€ Successfully pushed manifest update"
            else
              echo "âŒ Failed to push manifest update"
            fi
          else
            echo "â„¹ï¸  No manifest changes to commit (manifest unchanged)"
          fi
        else
          echo "âš ï¸  No manifest file found after generation"
        fi
        
        popd >/dev/null
        echo "=== MANIFEST GENERATION COMPLETE ==="

    - name: Workflow Summary
      if: always()
      run: |
        echo "=== WORKFLOW EXECUTION SUMMARY ==="
        echo "ğŸ“… Execution date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸŒ Repository: ${{ github.repository }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸƒ Triggered by: ${{ github.event_name }}"
        echo "ğŸ•°ï¸ Workflow run ID: ${{ github.run_id }}"
        
        # Check step outcomes
        echo "ğŸ” Step execution status:"
        echo "  - LibreOffice installation: ${{ steps.install-libreoffice.outcome || 'not executed' }}"
        echo "  - Git state debug: ${{ steps.debug-git.outcome || 'not executed' }}"
        echo "  - Change detection: ${{ steps.changed-files.outcome || 'not executed' }}"
        echo "  - Conversion: ${{ steps.convert.outcome || 'skipped' }}"
        echo "  - Deployment: ${{ steps.deploy.outcome || 'skipped' }}"
        echo "  - Manifest generation: ${{ steps.manifest.outcome || 'skipped' }}"
        
        # Overall workflow status
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… WORKFLOW STATUS: SUCCESS"
        elif [ "${{ job.status }}" == "failure" ]; then
          echo "âŒ WORKFLOW STATUS: FAILED"
          echo "ğŸ” Check the failed steps above for error details"
        elif [ "${{ job.status }}" == "cancelled" ]; then
          echo "âš ï¸  WORKFLOW STATUS: CANCELLED"
        else
          echo "ğŸ”„ WORKFLOW STATUS: ${{ job.status }}"
        fi
        
        # File processing summary
        if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
          echo "ğŸŸ¢ PROCESSING RESULT: CHANGES DETECTED AND PROCESSED"
          echo "ğŸ“„ Files in scope: $(echo '${{ steps.changed-files.outputs.all_changed_files }}' | wc -w)"
          echo "ğŸ¯ Target repository: peerf-eco/docs-vitepress"
          
          # Check if conversion actually succeeded
          if [ "${{ steps.convert.outcome }}" == "success" ]; then
            echo "âœ… Conversion completed successfully"
          elif [ "${{ steps.convert.outcome }}" == "failure" ]; then
            echo "âŒ Conversion failed - check conversion logs"
          fi
          
          # Check if deployment succeeded
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "âœ… Deployment completed successfully"
          elif [ "${{ steps.deploy.outcome }}" == "failure" ]; then
            echo "âŒ Deployment failed - check deployment logs"
          fi
        else
          echo "ğŸŸ¡ PROCESSING RESULT: NO CHANGES DETECTED"
          echo "ğŸ“„ Files processed: 0"
          echo "ğŸ¯ Target repository: No updates needed"
        fi
        
        # Troubleshooting guidance
        if [ "${{ job.status }}" != "success" ]; then
          echo ""
          echo "ğŸ”§ TROUBLESHOOTING GUIDANCE:"
          echo "  1. Check the step-by-step logs above for specific error messages"
          echo "  2. Look for âŒ (error) and âš ï¸ (warning) indicators in the logs"
          echo "  3. Verify that .fodt files exist in the components/ directory"
          echo "  4. Ensure SSH keys and repository permissions are correct"
          echo "  5. Check if LibreOffice and DocExport extension installed properly"
        fi
        
        echo "ğŸ” For detailed logs, check the individual step outputs above"
        echo "=== END WORKFLOW SUMMARY ==="
